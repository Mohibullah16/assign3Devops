<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Manager</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <style>
        body {
            font-size: 0.9rem;
        }
        h2 {
            font-size: 1.4rem;
        }
        h4, h5 {
            font-size: 1rem;
        }
        @media (max-width: 768px) {
            body {
                font-size: 0.85rem;
            }
            .order-header {
                flex-direction: column;
                align-items: flex-start !important;
                gap: 0.5rem;
            }
            .actions {
                width: 100%;
            }
        }
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        @media (max-width: 768px) {
            .kpi-grid {
                grid-template-columns: 1fr;
            }
        }
        .kpi-card {
            background: #4a5568;
            color: white;
            padding: 0.75rem;
            border-radius: 6px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
            transition: box-shadow 0.2s ease;
        }
        .kpi-card:hover {
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        }
        .kpi-value {
            font-size: 1.25rem;
            font-weight: 600;
            color: white;
            margin: 0.25rem 0;
        }
        .kpi-label {
            color: rgba(255, 255, 255, 0.95);
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            font-weight: 400;
        }
        .order-item {
            background: var(--pico-card-background-color);
            padding: 1.25rem;
            margin-bottom: 1rem;
            border-radius: 6px;
            border-left: 3px solid #4a5568;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            transition: box-shadow 0.2s ease;
        }
        .order-item:hover {
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
        }
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .order-meta {
            color: var(--pico-muted-color);
            font-size: 0.8rem;
            line-height: 1.5;
        }
        .items-list {
            margin-top: 0.5rem;
            padding-left: 1rem;
        }
        .item-detail {
            padding: 0.25rem 0;
            font-size: 0.85rem;
        }
        .actions {
            display: flex;
            gap: 0.5rem;
        }
        .btn-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        #addOrderForm {
            background: var(--pico-card-background-color);
            padding: 1.5rem;
            border-radius: 6px;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        .line-item {
            background: var(--pico-background-color);
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 4px;
            position: relative;
            border: 1px solid var(--pico-muted-border-color);
        }
        @media (max-width: 600px) {
            .line-item > div {
                grid-template-columns: 1fr !important;
            }
            .line-item label {
                grid-column: 1 / -1 !important;
            }
        }
        .remove-item-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
        }
        #ocrUploadSection {
            text-align: center;
            padding: 1.5rem;
            border: 2px dashed #4a5568;
            border-radius: 6px;
            margin-bottom: 1rem;
            background: rgba(74, 85, 104, 0.05);
        }
        #ocrStatus {
            margin-top: 1rem;
            font-style: italic;
        }
        #cameraModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        #cameraModal.active {
            display: flex;
        }
        .camera-container {
            max-width: 90%;
            max-height: 90%;
            background: white;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }
        #cameraVideo {
            max-width: 100%;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        #capturedCanvas {
            display: none;
            max-width: 100%;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        .camera-controls {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <main class="container">
        <header style="text-align: center; margin-bottom: 2rem;">
            <h1 style="font-size: 1.75rem; margin-bottom: 0.5rem; color: #333;">üì¶ Order Manager</h1>
            <p style="color: #666; font-size: 0.9rem;">Manage orders with OCR-powered invoice scanning</p>
            <div style="margin-top: 1rem;">
                <a href="/items" role="button" class="secondary" style="font-size: 0.85rem;">üìã View Items Database</a>
            </div>
        </header>

        <!-- KPI Dashboard -->
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-label">Total Spend</div>
                <div class="kpi-value">PKR {{ "{:,.2f}".format(kpis.spend) }}</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Total Orders</div>
                <div class="kpi-value">{{ kpis.count }}</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Average Order Value</div>
                <div class="kpi-value">PKR {{ "{:,.2f}".format(kpis.avg) }}</div>
            </div>
        </div>

        <!-- Search Bar -->
        <div style="margin-bottom: 1.5rem;">
            <input type="search" id="searchInput" placeholder="üîç Search orders by invoice, customer, salesman, item description, or SKU..." 
                   value="{{ search_query or '' }}" 
                   style="width: 100%; font-size: 0.9rem; padding: 0.5rem 0.75rem;">
        </div>

        <!-- Add Order Form -->
        <details {% if show_form %}open{% endif %}>
            <summary><strong>‚ûï Add New Order</strong></summary>
            
            <div id="addOrderForm">
                <!-- OCR Upload Section -->
                <div id="ocrUploadSection">
                    <h4>üì∏ Upload or Capture Invoice for OCR</h4>
                    <div style="display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap;">
                        <input type="file" id="invoiceImage" name="invoice" accept="image/*" style="flex: 1; min-width: 200px;">
                        <button type="button" id="ocrSubmitBtn" onclick="submitOCR()">Scan Invoice</button>
                        <button type="button" class="secondary" onclick="openCamera()">üì∑ Use Camera</button>
                    </div>
                    <div id="ocrStatus"></div>
                </div>

                <p style="text-align: center; color: var(--pico-muted-color);">‚Äî OR ‚Äî</p>

                <!-- Manual Entry Form -->
                <form id="addOrderFormElement" method="POST" action="/orders/add">
                    <label>
                        Invoice Number
                        <input type="text" name="invoice_number" id="invoice_number" required>
                    </label>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <label>
                            Customer Name <small>(optional)</small>
                            <input type="text" name="customer_name" id="customer_name" placeholder="Optional">
                        </label>
                        <label>
                            Salesman Name <small>(optional)</small>
                            <input type="text" name="salesman_name" id="salesman_name" placeholder="Optional">
                        </label>
                    </div>

                    <h5>Line Items</h5>
                    <div id="lineItemsContainer">
                        <!-- Line items will be added here -->
                    </div>
                    
                    <div class="btn-group">
                        <button type="button" onclick="addLineItem()" class="secondary">+ Add Item</button>
                        <button type="submit">Save Order</button>
                    </div>
                </form>
            </div>
        </details>

        <hr>

        <!-- Orders List -->
        <h2>Orders ({{ orders|length }})</h2>
        {% if orders %}
            {% for order in orders %}
            <div class="order-item">
                <div class="order-header">
                    <div>
                        <strong>Invoice #{{ order['invoice_number'] }}</strong>
                        <div class="order-meta">
                            üë§ {{ order['customer_name'] }} | ü§ù {{ order['salesman_name'] }}
                            <br>üìÖ {{ order['created_at'].strftime('%Y-%m-%d %H:%M') if order.get('created_at') else 'N/A' }}
                        </div>
                    </div>
                    <div class="actions">
                        <a href="/orders/{{ order['_id'] }}/edit" role="button" class="secondary">Edit</a>
                        <button onclick="deleteOrder('{{ order['_id'] }}')" class="contrast">Delete</button>
                    </div>
                </div>
                
                <details>
                    <summary><strong>Items ({{ order['total_quantity'] }})</strong> - Total: <strong>PKR {{ "{:,.2f}".format(order['total_amount']) }}</strong></summary>
                    <div class="items-list">
                        {% for item in order['items'] %}
                        <div class="item-detail">
                            {{ item['sr_no'] }}. <strong>{{ item['description'] }}</strong> (SKU: {{ item['sku'] }})
                            - Qty: {{ item['qty'] }} √ó PKR {{ "{:,.2f}".format(item['price']) }} = PKR {{ "{:,.2f}".format(item['amount']) }}
                        </div>
                        {% endfor %}
                    </div>
                </details>
            </div>
            {% endfor %}
        {% else %}
            <article>
                <p>No orders found. {% if search_query %}Try a different search.{% else %}Add your first order above!{% endif %}</p>
            </article>
        {% endif %}
    </main>

    <!-- Camera Modal -->
    <div id="cameraModal">
        <div class="camera-container">
            <h4>üì∑ Capture Invoice</h4>
            <video id="cameraVideo" autoplay playsinline></video>
            <canvas id="capturedCanvas"></canvas>
            <div class="camera-controls">
                <button type="button" id="captureBtn" onclick="capturePhoto()">üì∏ Capture</button>
                <button type="button" id="useCapturedBtn" onclick="useCapturedImage()" style="display: none;">‚úÖ Use This Photo</button>
                <button type="button" id="retakeBtn" onclick="retakePhoto()" style="display: none;" class="secondary">üîÑ Retake</button>
                <button type="button" onclick="closeCamera()" class="contrast">‚úï Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let itemCounter = 0;
        let cameraStream = null;
        let capturedImageBlob = null;

        function addLineItem(data = {}) {
            itemCounter++;
            const container = document.getElementById('lineItemsContainer');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'line-item';
            itemDiv.id = `item-${itemCounter}`;
            
            itemDiv.innerHTML = `
                <button type="button" class="remove-item-btn secondary" onclick="removeLineItem(${itemCounter})">‚úï</button>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                    <label style="grid-column: 1 / 2;">
                        Sr#
                        <input type="number" name="sr_no[]" value="${data.sr_no || itemCounter}" required>
                    </label>
                    <label style="grid-column: 2 / 3;">
                        SKU
                        <input type="text" name="sku[]" value="${data.sku || ''}" required>
                    </label>
                    <label style="grid-column: 1 / -1;">
                        Description
                        <input type="text" name="description[]" value="${data.description || ''}" required>
                    </label>
                    <label style="grid-column: 1 / 2;">
                        Qty
                        <input type="number" name="qty[]" value="${data.qty || 1}" min="1" required>
                    </label>
                    <label style="grid-column: 2 / 3;">
                        Price (PKR)
                        <input type="number" name="price[]" step="0.01" value="${data.price || ''}" required>
                    </label>
                </div>
            `;
            
            container.appendChild(itemDiv);
        }

        function removeLineItem(id) {
            document.getElementById(`item-${id}`).remove();
        }

        function deleteOrder(orderId) {
            if (confirm('Are you sure you want to delete this order?')) {
                fetch(`/orders/${orderId}/delete`, {
                    method: 'POST'
                }).then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Failed to delete order');
                    }
                });
            }
        }

        // Camera Functions
        async function openCamera() {
            const modal = document.getElementById('cameraModal');
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('capturedCanvas');
            
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment', // Use back camera on mobile devices
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    } 
                });
                video.srcObject = cameraStream;
                video.style.display = 'block';
                canvas.style.display = 'none';
                
                document.getElementById('captureBtn').style.display = 'inline-block';
                document.getElementById('useCapturedBtn').style.display = 'none';
                document.getElementById('retakeBtn').style.display = 'none';
                
                modal.classList.add('active');
            } catch (error) {
                alert('Unable to access camera: ' + error.message);
            }
        }

        function capturePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('capturedCanvas');
            const context = canvas.getContext('2d');
            
            // Set canvas size to video size
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Draw video frame to canvas
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Convert canvas to blob
            canvas.toBlob((blob) => {
                capturedImageBlob = blob;
            }, 'image/jpeg', 0.95);
            
            // Hide video, show canvas
            video.style.display = 'none';
            canvas.style.display = 'block';
            
            // Update buttons
            document.getElementById('captureBtn').style.display = 'none';
            document.getElementById('useCapturedBtn').style.display = 'inline-block';
            document.getElementById('retakeBtn').style.display = 'inline-block';
        }

        function retakePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('capturedCanvas');
            
            video.style.display = 'block';
            canvas.style.display = 'none';
            
            document.getElementById('captureBtn').style.display = 'inline-block';
            document.getElementById('useCapturedBtn').style.display = 'none';
            document.getElementById('retakeBtn').style.display = 'none';
            
            capturedImageBlob = null;
        }

        function closeCamera() {
            const modal = document.getElementById('cameraModal');
            const video = document.getElementById('cameraVideo');
            
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            video.srcObject = null;
            modal.classList.remove('active');
            capturedImageBlob = null;
        }

        async function useCapturedImage() {
            if (!capturedImageBlob) {
                alert('No image captured');
                return;
            }
            
            closeCamera();
            
            // Process the captured image through OCR
            const formData = new FormData();
            formData.append('file', capturedImageBlob, 'camera-capture.jpg');
            
            const statusDiv = document.getElementById('ocrStatus');
            const submitBtn = document.getElementById('ocrSubmitBtn');
            
            statusDiv.innerHTML = '‚è≥ Processing captured image...';
            submitBtn.disabled = true;
            
            try {
                const response = await fetch('/process_ocr', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    statusDiv.innerHTML = '‚úÖ Invoice scanned successfully! Filling form...';
                    fillFormWithOCRData(result.data);
                } else {
                    statusDiv.innerHTML = `‚ùå Error: ${result.error || 'Failed to process invoice'}`;
                }
            } catch (error) {
                statusDiv.innerHTML = `‚ùå Error: ${error.message}`;
            } finally {
                submitBtn.disabled = false;
            }
        }

        // OCR Upload Handler
        async function submitOCR() {
            const fileInput = document.getElementById('invoiceImage');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                alert('Please select an image file');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            
            const statusDiv = document.getElementById('ocrStatus');
            const submitBtn = document.getElementById('ocrSubmitBtn');
            
            statusDiv.innerHTML = '‚è≥ Processing invoice...';
            submitBtn.disabled = true;
            
            try {
                const response = await fetch('/process_ocr', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    statusDiv.innerHTML = '‚úÖ Invoice scanned successfully! Filling form...';
                    fillFormWithOCRData(result.data);
                    fileInput.value = '';
                } else {
                    statusDiv.innerHTML = `‚ùå Error: ${result.error || 'Failed to process invoice'}`;
                }
            } catch (error) {
                statusDiv.innerHTML = `‚ùå Error: ${error.message}`;
            } finally {
                submitBtn.disabled = false;
            }
        }

        // Helper function to fill form with OCR data
        function fillFormWithOCRData(data) {
            // Parse the nested JSON data
            const parsedData = typeof data === 'string' ? JSON.parse(data) : data;
            
            // Fill form fields from header
            if (parsedData.header) {
                document.getElementById('invoice_number').value = parsedData.header.invoice_number || '';
                document.getElementById('customer_name').value = parsedData.header.customer || '';
                document.getElementById('salesman_name').value = parsedData.header.salesman || '';
            }
            
            // Clear and add items
            document.getElementById('lineItemsContainer').innerHTML = '';
            itemCounter = 0;
            
            if (parsedData.items && parsedData.items.length > 0) {
                parsedData.items.forEach(item => addLineItem(item));
            } else {
                addLineItem();
            }
            
            setTimeout(() => {
                document.getElementById('ocrStatus').innerHTML = '';
            }, 3000);
        }

        // Add one item by default when page loads
        if (document.getElementById('lineItemsContainer').children.length === 0) {
            addLineItem();
        }

        // Form submission validation
        document.getElementById('addOrderFormElement')?.addEventListener('submit', function(e) {
            const container = document.getElementById('lineItemsContainer');
            if (container.children.length === 0) {
                e.preventDefault();
                alert('Please add at least one line item');
                return false;
            }
        });

        // Real-time search functionality
        const searchInput = document.getElementById('searchInput');
        const orderItems = document.querySelectorAll('.order-item');
        
        searchInput?.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase().trim();
            
            if (searchTerm === '') {
                // Show all orders when search is empty
                orderItems.forEach(item => {
                    item.style.display = 'block';
                });
                return;
            }
            
            // Filter orders based on search term
            orderItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>
